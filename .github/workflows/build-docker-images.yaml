name: Build Docker Images
run-name: Build Docker Images
# This workflow builds OSS/Community Edition Teleport Docker images following
# the official build process documented in README.md. It uses the dockerized
# build approach (make -C build.assets build-binaries) and explicitly builds
# OSS packages (oss-deb) which are licensed under the modified Apache 2.0
# license (build.assets/LICENSE-community).

on:
  workflow_dispatch:

jobs:
  build-packages:
    name: Build Debian Packages
    runs-on: self-hosted

    permissions:
      contents: read

    steps:
      - name: Install build tools
        run: |
          set -e
          echo "Checking for make..."
          if command -v make &> /dev/null; then
            echo "make is already installed: $(make --version | head -1)"
          else
            echo "make not found, installing..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y make build-essential
            elif command -v yum &> /dev/null; then
              sudo yum install -y make gcc
            elif command -v dnf &> /dev/null; then
              sudo dnf install -y make gcc
            elif command -v apk &> /dev/null; then
              sudo apk add make gcc musl-dev
            else
              echo "Unknown package manager. Please install make manually."
              exit 1
            fi
            echo "Verifying make installation..."
            make --version || (echo "make installation failed" && exit 1)
          fi

      - name: Checkout Teleport
        uses: actions/checkout@v4

      - name: Install Go
        run: |
          set -e
          echo "Checking for Go..."
          if command -v go &> /dev/null; then
            echo "Go is already installed: $(go version)"
          else
            echo "Go not found, installing..."
            GO_VERSION=$(cd build.assets && make -s print-go-version 2>/dev/null | sed 's/go//' || echo "1.24.6")
            echo "Installing Go ${GO_VERSION}..."
            curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tar.gz
            sudo rm -rf /usr/local/go
            sudo tar -C /usr/local -xzf /tmp/go.tar.gz
            echo "export PATH=/usr/local/go/bin:\$PATH" | sudo tee -a /etc/profile.d/go.sh
            export PATH=/usr/local/go/bin:$PATH
            echo "Verifying Go installation..."
            /usr/local/go/bin/go version || (echo "Go installation failed" && exit 1)
          fi
          # Ensure Go is in PATH for subsequent steps
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          driver: docker

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^VERSION=' Makefile | cut -d= -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="amd64"
          fi
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

      - name: Build buildbox-centos7-assets (from source)
        run: |
          cd build.assets
          # Ensure ARCH is set correctly for the build
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
          # Set non-root UID/GID if running as root (UID 0)
          RUNNER_UID=$(id -u)
          RUNNER_GID=$(id -g)
          if [ "$RUNNER_UID" = "0" ]; then
            RUNNER_UID=1000
            RUNNER_GID=1000
          fi
          make build-centos7-assets ARCH=$ARCH UID=$RUNNER_UID GID=$RUNNER_GID

      - name: Build buildbox-centos7 (from source)
        run: |
          cd build.assets
          # Ensure ARCH is set correctly for the build
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
          # Set non-root UID/GID if running as root (UID 0)
          RUNNER_UID=$(id -u)
          RUNNER_GID=$(id -g)
          if [ "$RUNNER_UID" = "0" ]; then
            RUNNER_UID=1000
            RUNNER_GID=1000
          fi
          make buildbox-centos7 ARCH=$ARCH UID=$RUNNER_UID GID=$RUNNER_GID

      - name: Build webassets (required for teleport binary)
        run: |
          cd build.assets
          # Set non-root UID/GID if running as root (UID 0)
          RUNNER_UID=$(id -u)
          RUNNER_GID=$(id -g)
          if [ "$RUNNER_UID" = "0" ]; then
            RUNNER_UID=1000
            RUNNER_GID=1000
          fi
          make webassets UID=$RUNNER_UID GID=$RUNNER_GID
        env:
          GOCACHE: /tmp/gocache

      - name: Build archive (required for .deb)
        run: |
          cd build.assets
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
          BUILDBOX_IMAGE="ghcr.io/gravitational/teleport-buildbox-centos7:teleport18-${ARCH}"
          docker run --rm \
            -v "$(pwd)/../":/go/src/github.com/gravitational/teleport \
            -w /go/src/github.com/gravitational/teleport \
            -e GOMODCACHE=/tmp/gomodcache \
            -e CI=true \
            -e WEBASSETS_SKIP_BUILD=1 \
            -e RDPCLIENT_SKIP_BUILD=1 \
            -e ADDFLAGS="-buildvcs=false" \
            $BUILDBOX_IMAGE \
            bash -c "rm -rf target/release/build target/release/deps/rdp_client* 2>/dev/null || true && make -C /go/src/github.com/gravitational/teleport full build-archive"

      - name: Build .deb package
        run: |
          cd build.assets
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
          BUILDBOX_IMAGE="ghcr.io/gravitational/teleport-buildbox-centos7:teleport18-${ARCH}"
          docker run --rm \
            -v "$(pwd)/../":/go/src/github.com/gravitational/teleport \
            -w /go/src/github.com/gravitational/teleport \
            -e GOMODCACHE=/tmp/gomodcache \
            -e CI=true \
            $BUILDBOX_IMAGE \
            make -C /go/src/github.com/gravitational/teleport oss-deb

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: teleport-deb-package
          path: build/*.deb
          if-no-files-found: error

  build-docker-images:
    name: Build Docker Images
    runs-on: self-hosted
    needs: build-packages

    permissions:
      contents: read

    steps:
      - name: Install build tools
        run: |
          set -e
          echo "Checking for make..."
          if command -v make &> /dev/null; then
            echo "make is already installed: $(make --version | head -1)"
          else
            echo "make not found, installing..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y make build-essential
            elif command -v yum &> /dev/null; then
              sudo yum install -y make gcc
            elif command -v dnf &> /dev/null; then
              sudo dnf install -y make gcc
            elif command -v apk &> /dev/null; then
              sudo apk add make gcc musl-dev
            else
              echo "Unknown package manager. Please install make manually."
              exit 1
            fi
            echo "Verifying make installation..."
            make --version || (echo "make installation failed" && exit 1)
          fi

      - name: Install Go
        run: |
          set -e
          echo "Checking for Go..."
          if command -v go &> /dev/null; then
            echo "Go is already installed: $(go version)"
          else
            echo "Go not found, installing..."
            GO_VERSION=$(cd build.assets && make -s print-go-version 2>/dev/null | sed 's/go//' || echo "1.24.6")
            echo "Installing Go ${GO_VERSION}..."
            curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tar.gz
            sudo rm -rf /usr/local/go
            sudo tar -C /usr/local -xzf /tmp/go.tar.gz
            echo "export PATH=/usr/local/go/bin:\$PATH" | sudo tee -a /etc/profile.d/go.sh
            export PATH=/usr/local/go/bin:$PATH
            echo "Verifying Go installation..."
            /usr/local/go/bin/go version || (echo "Go installation failed" && exit 1)
          fi
          # Ensure Go is in PATH for subsequent steps
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Checkout Teleport
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          driver: docker

      - name: Download .deb package
        uses: actions/download-artifact@v4
        with:
          name: teleport-deb-package
          path: build/

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^VERSION=' Makefile | cut -d= -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="amd64"
          fi
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

      - name: Copy fetch-debs script
        run: |
          cp build.assets/charts/fetch-debs build/

      - name: Prepare .deb file for Docker build
        run: |
          DEB_FILE=$(find build/ -name "teleport_*.deb" -type f | head -1)
          if [ -z "$DEB_FILE" ]; then
            echo "Error: .deb file not found"
            exit 1
          fi
          EXPECTED_NAME="teleport_${{ steps.version.outputs.version }}_${{ steps.arch.outputs.arch }}.deb"
          if [ "$(basename "$DEB_FILE")" != "$EXPECTED_NAME" ]; then
            cp "$DEB_FILE" "build/$EXPECTED_NAME"
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set image tags
        id: tags
        run: |
          TAGS="aazmy/teleport:${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }}"
          TAGS="$TAGS,aazmy/teleport:${{ steps.version.outputs.version }}"
          if [ "${{ steps.arch.outputs.arch }}" = "amd64" ]; then
            TAGS="$TAGS,aazmy/teleport:latest"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Tags: $TAGS"

      - name: Build and push Teleport Docker image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: build/
          file: build.assets/charts/Dockerfile-distroless
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            TELEPORT_VERSION=${{ steps.version.outputs.version }}
            TELEPORT_RELEASE_INFIX=
            TARGETARCH=${{ steps.arch.outputs.arch }}
          platforms: linux/${{ steps.arch.outputs.arch }}

      - name: Save Docker image (for artifact backup)
        run: |
          docker pull aazmy/teleport:${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }}
          docker save aazmy/teleport:${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }} \
            -o build/teleport-image-${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }}.tar

      - name: Upload Docker image (backup)
        uses: actions/upload-artifact@v4
        with:
          name: teleport-docker-image
          path: build/teleport-image-*.tar
          if-no-files-found: warn

