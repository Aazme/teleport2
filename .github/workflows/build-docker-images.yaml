name: Build Docker Images
run-name: Build Docker Images

on:
  workflow_dispatch:

jobs:
  build-packages:
    name: Build Debian Packages
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          driver: docker

      - name: Get Go version
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "go-version=${GO_VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.go-version }}
          cache: false

      - name: Build binaries for package
        run: |
          make build/tsh build/tbot build/tctl build/teleport

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^VERSION=' Makefile | cut -d= -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="amd64"
          fi
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

      - name: Build archive (required for .deb)
        run: |
          cd build.assets
          docker run --rm \
            -v "$(pwd)/../":/go/src/github.com/gravitational/teleport \
            -w /go/src/github.com/gravitational/teleport \
            -e GOMODCACHE=/tmp/gomodcache \
            -e CI=true \
            ghcr.io/gravitational/teleport-buildbox-centos7:teleport18-amd64 \
            make -C /go/src/github.com/gravitational/teleport build-archive

      - name: Build .deb package
        run: |
          cd build.assets
          docker run --rm \
            -v "$(pwd)/../":/go/src/github.com/gravitational/teleport \
            -w /go/src/github.com/gravitational/teleport \
            -e GOMODCACHE=/tmp/gomodcache \
            -e CI=true \
            ghcr.io/gravitational/teleport-buildbox-centos7:teleport18-amd64 \
            make -C /go/src/github.com/gravitational/teleport oss-deb

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: teleport-deb-package
          path: build/*.deb
          if-no-files-found: error

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-packages

    permissions:
      contents: read

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          driver: docker

      - name: Download .deb package
        uses: actions/download-artifact@v4
        with:
          name: teleport-deb-package
          path: build/

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^VERSION=' Makefile | cut -d= -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="amd64"
          fi
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

      - name: Copy fetch-debs script
        run: |
          cp build.assets/charts/fetch-debs build/

      - name: Prepare .deb file for Docker build
        run: |
          DEB_FILE=$(find build/ -name "teleport_*.deb" -type f | head -1)
          if [ -z "$DEB_FILE" ]; then
            echo "Error: .deb file not found"
            exit 1
          fi
          EXPECTED_NAME="teleport_${{ steps.version.outputs.version }}_${{ steps.arch.outputs.arch }}.deb"
          if [ "$(basename "$DEB_FILE")" != "$EXPECTED_NAME" ]; then
            cp "$DEB_FILE" "build/$EXPECTED_NAME"
          fi

      - name: Build Teleport Docker image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: build/
          file: build.assets/charts/Dockerfile-distroless
          push: false
          tags: teleport:${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }}
          build-args: |
            TELEPORT_VERSION=${{ steps.version.outputs.version }}
            TELEPORT_RELEASE_INFIX=
            TARGETARCH=${{ steps.arch.outputs.arch }}
          load: true

      - name: Save Docker image
        run: |
          docker save teleport:${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }} \
            -o build/teleport-image-${{ steps.version.outputs.version }}-${{ steps.arch.outputs.arch }}.tar

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: teleport-docker-image
          path: build/teleport-image-*.tar
          if-no-files-found: error

